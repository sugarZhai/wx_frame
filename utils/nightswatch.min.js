"use strict";function NWCollector(t){this.nw=t;try{this._populateSysInfo(t),App=this.proxyApp(App,t),Page=this.proxyPage(Page,t)}catch(t){console.error(t)}}function NWReportor(t,e){this.nw=t,this.config=e,this.counter=0,this.timer=0,this.events=[],this.serverUrl=this.envs[this.config.env||"prd"],this.serverUrl||Logger.error("env 传参有误")}function NightsWatch(){this._config={env:"prd",ready:!1},this._fields={},this._buffer=[]}var Util={isObject(t){return"[object Object]"===Object.prototype.toString.call(t)},isFunc(t){return"function"==typeof t},merge(t,e,n){if(this.isObject(t)&&this.isObject(e))for(var i in e)!0===n&&this.isObject(t[i])&&this.isObject(e[i])?this.merge(t[i],e[i]):t[i]=e[i];return t},param(t){return this.isObject(t)?Object.keys(t).map(e=>e+"="+t[e]).join("&"):""},formatDate(t){return[t.getFullYear(),t.getMonth()+1,t.getDate()].join("/")+" "+[t.getHours(),t.getMinutes(),t.getSeconds()].join(":")}},pt$1=NWCollector.prototype;pt$1.proxyApp=function(t,e){return function(n){n.NW=e;var i=n.onLaunch,o=n.onShow;n.onLaunch=function(t){i.apply(this,arguments),this.NW.setData({scene:t.scene,subscene:t.query.scene||""}),this.NW.send("launch",{extraInfo:t})},n.onShow=function(t){o.apply(this,arguments),this.NW.setData({scene:t.scene,subscene:t.query.scene||""})},t.apply(null,arguments)}},pt$1.proxyPage=function(t,e){return function(n){n.NW=e;var i=n.onLoad,o=n.onShow;Util.isObject(n.nw_fields)||(n.nw_fields={});for(var s in n)"function"!=typeof n[s]||/^(onShow|onLoad)$/.test(s)||(n[s]=function(t){return function(e){return Util.isObject(e)&&this.nw_send(e),t.apply(this,arguments)}}(n[s]));n.nw_send=function(t="pv",e){if(t.target&&t.currentTarget){if(1==t.__nw_handled)return;var n=t.currentTarget.dataset;n.nw&&this.NW.send("asm",this.nw_fields,{asmId:n.nw,asmName:n.nwname||"",extraInfo:n.extrainfo||""}),t.__nw_handled=!0}else"string"==typeof t&&this.NW.send(t,this.nw_fields,e)},n.nw_set=function(t,e){return Util.isObject(t)?Util.merge(this.nw_fields,t):"string"==typeof t&&(this.nw_fields[t]=e),this},n.onLoad=function(t){i.apply(this,arguments),Util.merge(this.nw_fields,{queryParam:Util.param(t),url:this.route})},n.onShow=function(){o.apply(this,arguments),!1!==this.nw_autopv&&this.nw_fields.pageId&&this.NW.send("pv",this.nw_fields)},t.apply(null,arguments)}},pt$1._populateSysInfo=function(t){wx.getSystemInfo({success:function(e){t.setData({platform:e.platform,system:e.system,appVersion:e.version,sdkVersion:e.SDKVersion,language:e.language,fontSizeSetting:e.fontSizeSetting||"",brand:e.brand||"",model:e.model,pixelRatio:e.pixelRatio,screenWidth:e.screenWidth,screenHeight:e.screenHeight,windowWidth:e.windowWidth,windowHeight:e.windowHeight})}})};var Logger={groupCollapsed(){let t=this.__injectArg(arguments);(console.groupCollapsed||console.info).apply(console,t)},groupEnd(){console.groupEnd&&console.groupEnd()},info(){let t=this.__injectArg(arguments);console.info.apply(console,t)},subInfo(){console.info.apply(console,arguments)},error(){let t=this.__injectArg(arguments);console.error.apply(console,t)},__injectArg(t){return(t=Array.from(t)).unshift(this.__getPrefix()),t},__getPrefix(){return`【${Util.formatDate(new Date)}】`}},pt$2=NWReportor.prototype;pt$2.envs={test:"https://tac-action-test.zhongan.com/userAction/create",uat:"https://tac-action-pre.zhongan.com/userAction/create",prd:"https://tac-action.zhongan.com/userAction/create"},pt$2.send=function(t){this.events.push(t),clearTimeout(this.timer),this.events.length>=20?this.report():this.timer=setTimeout(this.report.bind(this),600)},pt$2.report=function(){if(this.events.length){let t=this.events;this.events=[];let e=++this.counter;wx.request({url:this.serverUrl,data:t,method:"POST",success(){Logger.info("NW 上报",e,"ok")}}),Logger.groupCollapsed("NW 第",e,"次上报"),t.forEach((t,e)=>{Logger.subInfo("【"+e+"】",JSON.stringify(t))}),Logger.groupEnd()}};var pt=NightsWatch.prototype;pt.config=function(t){return Util.merge(this._config,t),this},pt.run=function(t){return this.config(t),this.reportor=new NWReportor(this,this._config),this.collector=new NWCollector(this,this._config),this},pt.setData=function(t,e){return Util.isObject(t)?Util.merge(this._fields,t):"string"==typeof t&&(this._fields[t]=e),this},pt.send=function(t,e,n){if(t&&"string"==typeof t)if(this._config.ready){let i={eventType:t,logTime:Date.now()};Util.merge(i,this._fields),Util.merge(i,e),Util.merge(i,n),Util.isObject(i.extraInfo)&&(i.extraInfo=JSON.stringify(i.extraInfo)),this.reportor.send(i)}else{let i={logTime:Date.now()};Util.merge(i,e),Util.merge(i,n),this._buffer.push({eventType:t,data:i})}return this},pt.ready=function(t,e){this.setData(t,e),1!=this._config.ready&&(this._config.ready=!0,this._buffer.map(t=>this.send(t.eventType,t.data)),this._buffer=[])},module.exports=new NightsWatch;
